---
layout: post
title: On Average
tags: statistics
---

Calculating the "mean":http://en.wikipedia.org/wiki/Average of a sample can be done in various ways. A widely used method is the exponential moving average. We will show that this method has a bias towards the initial value, and present a way to remove the bias from the results.

<!--more-->

h2. Arithmetic average

We are going to start with the "arithmetic mean":http://en.wikipedia.org/wiki/Arithmetic_mean to have a reference for the discussion below . The arithmetic mean of a sample *X* is given by summing all values X[~i~] in the sample and dividing the sum by the sample size N:

|>.M|=|( &sum;[^N^][~k=1~]X[~k~] ) &frasl; N|

Let us visualize how this evolves as we add more values to the sample. When we add the first value X[~1~] at iteration N = 1 it will be equal to the mean. In other words, X[~1~] will contribute 100% to the mean. When we add the next value X[~2~] at iteration N = 2, both X[~1~] and X[~2~] values will contribute 50% to the mean. This pattern will continue as we add even more values to the sample; no surprises here.

table(imagetable).
|!{width:70%}/assets/average-arithmetic.png!|
|=. _Figure 1: Arithmetic Average._ Each X[~k~] value contributes in equal proportion as N is increased.|

This is illustrated in Figure 1, where a stacked bar chart is used to show the proportion by which each value X[~k~] contributes to the mean. The x-axis shows the development as more values are added to the sample.

h2. Exponential average

Another technique for calculating the average is the "exponential moving average":http://en.wikipedia.org/wiki/Exponential_smoothing given by recurrent formula:

|>.M[~1~]|=|X[~1~]|
|>.M[~i~]|=|&alpha; X[~i~] + (1 - &alpha;) M[~i-1~]|

where &alpha; is a smoothing factor.

This technique has the clear advantage that we do not need to keep all previous values; we only need to store the previously calculated mean M[~i-1~].

This leanness makes the exponential moving average quite popular in practical applications. For instance, it is used to calculate the smoothed round-trip time in the "TCP":http://tools.ietf.org/html/rfc6298 protocol.

In the examples below we are going to use &alpha; = [^1^]&frasl;[~8~], which happens to be the smoothing factor chosen by TCP. The general observations also hold for other values of &alpha; albeit some thresholds may be different.

In order to better understand the recurrent formula above, we rewrite it as a sum:

|>.M'[~i~]|=|(1 - &alpha;)[^i-1^] X[~1~] + &alpha; &sum;[~k=2~] (1 - &alpha;)[^i-k^] X[~k~]|

If we plot the evolvement of this formula just as we did for the arithmetic average, then we arrive at Figure 2. This graph shows a quite surprising feature of the exponential moving average, namely that the initial value X[~1~] dominates the results for many iterations.

table(imagetable).
|!{width:70%}/assets/average-exponential.png!|
|=. _Figure 2: Exponential Average._ The initial value X[~1~] contributes disproportionately.|

Normally we would expect that a value X[~i~] contributes more to the result that then previous value X[~i-1~]. This is true for all values except the initial value X[~1~].

We would furthermore expect that the most recently added value X[~N~] contributes more that any of the other individual values X[~i~], but that is not true for the first 16 iterations, where the initial value X[~1~] continues to dominate.

The bad news is that the moving exponential average filter is critically dependent on a good measurement for the initial value. If the initial value is way off compared with the subsequent values, then it will take many iterations before this outlier is smoothed out.

h2. Normalization

The problem with the bias of the initial value is inherent in the recurrent formula for the exponential moving average:

|>.M[~1~]|=|X[~1~]|
|>.M[~i~]|=|&alpha; X[~i~] + (1 - &alpha;) M[~i-1~]|

The first equation treats the initial value as a special value in order to get the subsequent values correct.

In the second equation, when we add a new value X[~i~] it contributes only by a factor of &alpha;. For &alpha; = [^1^]&frasl;[~8~] this becomes 12.5%. The remaining 87.5% comes from the previously calculated mean M[~i-1~]. This is generally a good solution, but we do have a bootstrap problem. This is solved by setting M[~1~] to X[~1~], but it also create the bias problem described in the previous section.

Let us dispense with the first equation in the recurrent formula as see if we can come up with a better solution.

In iteration 1 we calculate the contribution of the initial value X[~1~] to be &alpha; = 12.5%. In iteration 2 the second value X[~2~] contributes 12.5% and X[~1~] contributes &alpha; &times; (1 - &alpha;) = 10.9%. We can derive the percentages for the remaining iterations from the second term in the non-recurrent formula M'[~i~].

This gives us values that are much too small during the initial iterations, so we need to scale the 12.5% of X[~1~] in iteration 1 to 100%, and the 12.5% + 10.9% for X[~2~] and X[~1~] in iteration 2 to 100%, and so on. In other words, in iteration 1 we must divide the calculated value by 12.5%, in iteration 2 by 12.5% + 10.9%, and so on.

We therefore introduce a normalization factor &gamma;[~i~]. Let us write out some of the values to extrapolate a formula:

|>.&gamma;[~1~]|=|&alpha;|=|12.5%|
|>.&gamma;[~2~]|=|&alpha; + &alpha; (1 - &alpha;)|=|12.5% + 10.9%|
|>.&gamma;[~3~]|=|&alpha; + &alpha; (1 - &alpha;) + &alpha; (1 - &alpha;)[^2^]|=|12.5% + 10.9% + 9.6%|
|>....|||||
|>.&gamma;[~i~]|=|&alpha; &sum;[^i^][~k=1~] (1 - &alpha;)[^k-1^]||

table(imagetable).
|!{width:70%}/assets/average-gamma.png!|
|=. _Figure 3: Normalization factor._ &gamma;[~i~] converges towards 100% as i grows.|

This formula can be rewritten as a recurrent formula:

|>.&Gamma;[~0~]|=|0|
|>.&Gamma;[~i~]|=|&alpha; + (1 - &alpha;) &Gamma;[~i-1~]|

We can incorporate this normalization factor into the exponential moving average and get an unbiased exponential moving average:

|>.MM[~0~]|=|0|
|>.MM[~i~]|=|&alpha; X[~i~] + (1 - &alpha;) MM[~i-1~]|
|>.M[~i~]|=|MM[~i~] / &Gamma;[~i~]|

table(imagetable).
|!{width:70%}/assets/average-unbiased.png!|
|=. _Figure 4: Unbiased Exponential Average._|

Figure 4 shows the results from the unbiased exponential moving average formula. It confirms that we get the expected results, namely firstly that normalization gives us correctly scaled values, and secondly that most recent values contributes more than older values.

Whereas the exponential moving average only maintains a single state variable M[~i~], the unbiased version maintains two state variables MM[~i~] and &Gamma;[~i~].
